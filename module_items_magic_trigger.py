# -*- coding: UTF-8 -*-
from header_common import *
from module_constants import *
from ID_factions import *
from header_items import  *
from header_operations import *
from header_troops import *
from header_triggers import *
from header_skills import *

from header_parties import *
from header_mission_templates import *
from header_terrain_types import *
from header_music import *
from header_map_icons import *
from header_skins import *


####################################################################################################################
#  Each item record contains the following fields:
#  1) Item id: used for referencing items in other files.
#     The prefix itm_ is automatically added before each item id.
#  2) Item name. Name of item as it'll appear in inventory window
#  3) List of meshes.  Each mesh record is a tuple containing the following fields:
#    3.1) Mesh name.
#    3.2) Modifier bits that this mesh matches.
#     Note that the first mesh record is the default.
#  4) Item flags. See header_items.py for a list of available flags.
#  5) Item capabilities. Used for which animations this item is used with. See header_items.py for a list of available flags.
#  6) Item value.
#  7) Item stats: Bitwise-or of various stats about the item such as:
#      weight, abundance, difficulty, head_armor, body_armor,leg_armor, etc...
#  8) Modifier bits: Modifiers that can be applied to this item.
#  9) [Optional] Triggers: List of simple triggers to be associated with the item.
#  10) [Optional] Factions: List of factions that item can be found as merchandise.
####################################################################################################################

cast_magic_burning_gaze = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",70),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 70),
        (val_add,":max_range",":range_add"),
        (store_add,":damage",":damage_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail_holy", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail_holy", pos5, 1),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", holy_fire, ":power", 5),
        (assign,":damage",65),
      (try_end),
    ])]

cast_magic_blinding_light = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 100),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", holy_fire, ":power", ":power"),
        (agent_set_slot, ":agent", slot_agent_special_damage_type, blinding),
        (agent_set_slot, ":agent", slot_agent_special_damage_power, 10),
        (agent_set_slot, ":agent", slot_agent_special_damage_time, 30),
      (try_end),
    ])]


cast_magic_net_of_amyntok = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

        (try_for_agents,":possable_agent"),
          (agent_is_active,":possable_agent"),
          (agent_is_alive,":possable_agent"),   
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),
          (agent_get_position,pos6,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos6),
          (lt,":dist",":max_range"),            	
          (agent_is_human, ":possable_agent"),

          (agent_is_human, ":possable_agent"),
          (position_move_z, pos6, 200),
          (particle_system_burst,"psys_stun_effect",pos6,1),
          #(agent_set_animation, ":possable_agent", "anim_bash_knocked"),  
          (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_type, "itm_magic_net_of_amyntok"),
          (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_time, 20),
        (try_end),
    ])]

cast_magic_light_of_battle = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_light_of_battle", ":max_range", 30),

    ])]

cast_magic_bironas_timewarp = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_bironas_timewarp", ":max_range", 60),

    ])]

cast_magic_banishment = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      #(item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",200),
        (store_mul,":range_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_mul,":damage_add",":power", 100),
        (store_add,":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
      
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (try_begin),
            (eq, ":player",":shooter"),
            (agent_get_slot, ":target", ":player", slot_agent_player_target),
          (else_try),
            (agent_ai_get_look_target, ":target", ":shooter"),
          (try_end),
          (gt,":target",0),
          (agent_is_alive,":target"),
          (neg|eq, ":player",":target"),
          (assign,":victim",":target"),
        (try_end),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),



        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
      
      (try_begin),
        (gt,":damage",0),
        (copy_position, pos40, pos5),
        (position_move_z, pos40, 400),
        (particle_system_burst, "psys_fright_aura2", pos40, 3),
        #(particle_system_burst, "psys_Freezing_Trail", pos5, 35),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", holy_fire, ":spec_power", ":power"),
      (try_end),
    ])]
    
cast_magic_harmonic_convergence = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_harmonic_convergence", ":max_range", 50),

    ])]

cast_magic_curse_of_the_midnight_wind = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_debuff", ":shooter", "itm_magic_curse_of_the_midnight_wind", ":max_range", 75),

    ])]

cast_magic_cascading_fire_cloak = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_cascading_fire_cloak", ":max_range", 20),
    ])]

cast_magic_regrowth = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_regrowth", ":max_range", 10),
    ])]

cast_magic_flesh_to_stone = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_flesh_to_stone", ":max_range", 20),
    ])]

cast_magic_wyssans_wildform = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_wyssans_wildform", ":max_range", 20),
    ])]

cast_magic_panns_impenetrable_belt = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_panns_impenetrable_belt", ":max_range", 30),
    ])]

cast_magic_okkams_mindrazor = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_okkams_mindrazor", ":max_range", 30),
    ])]

cast_magic_soulblight = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_debuff", ":shooter", "itm_magic_soulblight", ":max_range", 35),
    ])]

cast_magic_transmutation_of_lead = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_debuff", ":shooter", "itm_magic_transmutation_of_lead", ":max_range", 40),
    ])]

cast_magic_curse_of_anraheir = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_debuff", ":shooter", "itm_magic_curse_of_anraheir", ":max_range", 20),
    ])]

cast_magic_wind_blast = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 100),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos6, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos6, 35),
        (particle_system_burst, "psys_bomb_smoke", pos6, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos6, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos6, 5),
        (particle_system_burst, "psys_bomb_smoke", pos6, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        #(val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", power_jump, ":power", 3),
        (agent_set_slot, ":agent", slot_agent_special_damage_type, power_jump),
        (agent_set_slot, ":agent", slot_agent_special_damage_power, ":power"),
        (agent_set_slot, ":agent", slot_agent_special_damage_time, 3),
      (try_end),
    ])]

cast_magic_comet_of_casandora = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      (assign,":damage",0),
      
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_nilfurs_boast"),
        (val_mul,":power",2),
      (try_end),
      
      (try_begin),
        (assign,":range",100),
        (assign,":damage",3),
        (store_mul,":damage_add",":power", 2),
        (store_mul,":range_add",":power", 30),
        (val_add,":range",":range_add"),
        (val_add,":damage",":damage_add"),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_add,":range",":range_add"),
        (val_add,":damage",":power"),
      (try_end),
        
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),

        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        #(val_mul,":damage",2),
        (try_for_range,":unused",0,":damage"),
          (copy_position,pos4,pos5),
          (store_random_in_range, ":posx", -50,51),
          (store_random_in_range, ":posy", -50,51),
          (store_random_in_range, ":posz", 10,100),
          (val_mul,":posx",30),
          (val_mul,":posy",30),
          (val_mul,":posz",100),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          #(position_move_z,pos5,":posz"),
          (add_missile, ":shooter", pos4, 80, ":weapon", 0, "itm_comet_of_casandora_dummy", 0),
        (try_end),
    ])]
    
cast_magic_burnished_gauntlet = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (this_or_next|eq,":weapon","itm_ebony_bow"),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
            
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (val_div,":max_range",10),
      (try_end),
       
      (copy_position,pos51,pos5),
      (call_script, "script_magic_deliver_area_damage", ":shooter", ":max_damage", ":max_range", 3),
    ])]

cast_magic_plague_of_rust = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", ":power"),
        
        (agent_set_slot, ":agent", slot_agent_special_damage_type, marked_for_death),
        (agent_set_slot, ":agent", slot_agent_special_damage_power, 10),
        (agent_set_slot, ":agent", slot_agent_special_damage_time, 30),
      (try_end),
    ])]

cast_magic_final_transmutation = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":dest_damage",":power", 100),
      (try_end),
      
      (copy_position,pos6,pos5),
      (particle_system_burst, "psys_Sandstorm", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", ":power"),
        
        (agent_get_troop_id, ":inflicted_troop", ":agent"),
        (store_skill_level, ":defence", skl_magic_defence, ":inflicted_troop"),
        (le,":defence",8),
        (troop_get_slot, ":inflicted_troop_max_hp", ":inflicted_troop", slot_troop_max_hp),
            
        (store_random_in_range, ":random_no", 0, ":inflicted_troop_max_hp"),
        (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 1),
            
        (this_or_next|ge,":random_no", ":inflicted_agent_hp"),
        (ge, ":dest_damage", ":inflicted_troop_max_hp"),
        (agent_set_hit_points,":agent",0,0),
        (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
      (try_end),
    ])]

cast_magic_earth_blood = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":heal",0),
      (gt,":weapon",0),
      
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                       
      (try_begin),
        (assign,":max_range",100),
        (assign,":heal",50),
        (store_mul,":range_add",":power", 100),
        (store_mul,":damage_add",":power", 10),
        (val_add,":max_range",":range_add"),
        (val_add,":heal",":damage_add"),
      (try_end),
      
      
        (try_for_agents,":possable_agent"),
          (gt,":heal",0),
          (agent_is_alive,":possable_agent"),

          (this_or_next|agent_is_ally,":shooter"),
          (neg|agent_is_ally,":possable_agent"),
          (this_or_next|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),


          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),

          (store_agent_hit_points, ":hp", ":agent",0),
          (val_add, ":hp", ":heal"),
          (agent_set_hit_points, ":agent", ":hp",0),
          (position_move_z,pos3,100),
          (particle_system_burst, "psys_heal_effect", pos3, 30), 
        (try_end),
    ])]
   
cast_magic_animal_mastery = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (agent_get_horse, ":horse_agent", ":agent"),
        (agent_get_troop_id, ":troop_id", ":agent"),
        (store_skill_level, ":riding", skl_riding, ":troop_id"),
        (store_random_in_range, ":rand", 1, 13),
        (val_add, ":rand", ":power"),
        (store_sub, ":pass", ":rand", ":riding"),
        (try_begin),
          (ge, ":pass", 1),
          (gt, ":horse_agent", -1),
          (agent_fade_out, ":horse_agent"),
          (remove_agent, ":horse_agent"),
        (try_end),
      (try_end),
    ])]

cast_magic_animate_tree = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":spawn_troop_id",0),
      (assign,":number",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
                  
      (store_character_level,":troop_level",":shooter_troop"),
      (val_mul,":power",5),
      (val_add,":power",":troop_level"),
      (try_begin),
        (ge, ":power", 60),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",2),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_ent_1"),
          (assign,":number",3),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_ent_2"),
          (assign,":number",3),
        (else_try),
          (eq, ":r", 2),
          (assign,":spawn_troop_id","trp_ent_1"),
        (else_try),
          (assign,":spawn_troop_id","trp_ent_2"),
        (try_end),
      (else_try),
        (ge, ":power", 40),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_ent_1"),
          (assign,":number",2),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_ent_2"),
          (assign,":number",2),
        (else_try),
          (eq, ":r", 2),
          (assign,":spawn_troop_id","trp_ent_1"),
        (else_try),
          (assign,":spawn_troop_id","trp_ent_2"),
        (try_end),
      (else_try),
        (ge, ":power", 20),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_ent_1"),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_ent_2"),
        (else_try),
          (assign,":spawn_troop_id","trp_dendroid"),
          (assign,":number",3),
        (try_end),
      (else_try),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 0),
          (assign,":spawn_troop_id","trp_ent_1"),
        (else_try),
          (assign,":spawn_troop_id","trp_dendroid"),
          (assign,":number",2),
        (try_end),
      (try_end),
            
      (gt,":spawn_troop_id",0),
      (gt,":number",0),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
        
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", ":number"),
    ])]
    
cast_magic_amber_spear = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (this_or_next|eq,":weapon","itm_ebony_bow"),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",50),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (val_div,":max_range",10),
      (try_end),
       
      (copy_position,pos51,pos5),
      (call_script, "script_magic_deliver_area_damage", ":shooter", ":max_damage", ":max_range", 3),
    ])]

cast_magic_bray_scream = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",70),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 70),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_human,":possable_agent"),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", 0, 0, 0),
        (agent_set_animation, ":agent", "anim_bash_mini_stun"),
        (agent_get_slot, ":agent_courage_score", ":agent",  slot_agent_courage_score),
        (val_sub, ":agent_courage_score", ":max_damage"),
        (agent_set_slot, ":agent", slot_agent_courage_score, ":agent_courage_score"),     
      (try_end),
    ])]

cast_magic_savage_dominion = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":spawn_troop_id",0),
      (assign,":number",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
                  
      (store_character_level,":troop_level",":shooter_troop"),
      (val_mul,":power",5),
      (val_add,":power",":troop_level"),
      (try_begin),
        (ge, ":power", 60),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",2),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_cyclop"),
          (assign,":number",3),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_troll_2"),
        (else_try),
          (eq, ":r", 2),
          (assign,":spawn_troop_id","trp_demon_4_3"),
        (else_try),
          (assign,":spawn_troop_id","trp_red_dragon"),
        (try_end),
      (else_try),
        (ge, ":power", 40),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_troll_1"),
          (assign,":number",2),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_rat_5_1"),
          (assign,":number",3),
        (else_try),
          (eq, ":r", 2),
          (assign,":spawn_troop_id","trp_demon_4_2"),
        (else_try),
          (assign,":spawn_troop_id","trp_cyclop"),
        (try_end),
      (else_try),
        (ge, ":power", 20),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_rat_3"),
          (assign,":number",3),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_minotaur_3"),
          (assign,":number",2),
        (else_try),
          (eq, ":r", 2),
          (assign,":spawn_troop_id","trp_orc_veterun_blackorc"),
          (assign,":number",3),
        (else_try),
          (assign,":spawn_troop_id","trp_cyclop"),
        (try_end),
      (else_try),
        (store_random_in_range, ":r", 0, 4),
        (assign,":number",1),
        (try_begin),
          (eq, ":r", 4),
          (assign,":spawn_troop_id","trp_rat_1"),
          (assign,":number",5),
        (else_try),
          (eq, ":r", 3),
          (assign,":spawn_troop_id","trp_orc_warrior"),
          (assign,":number",3),
        (else_try),
          (eq, ":r", 2),
          (assign,":spawn_troop_id","trp_minotaur_2"),
          (assign,":number",2),
        (else_try),
          (assign,":spawn_troop_id","trp_cyclop"),
        (try_end),
      (try_end),
            
      (gt,":spawn_troop_id",0),
      (gt,":number",0),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
        
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", ":number"),
    ])]
    
cast_magic_shadow_bolt = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",70),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 70),
        (val_add,":max_range",":range_add"),
        (store_add,":damage",":damage_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_magic_curse_small", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_magic_curse_small", pos5, 1),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", curse, ":power", 5),
        (assign,":damage",65),
      (try_end),
    ])]

cast_melkoths_mystifying_miasma = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 100),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_magic_curse_small", pos6, 3),
      
        (try_for_agents,":possable_agent"),
          (gt,":damage",0),
          (agent_is_alive,":possable_agent"),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":possable_agent"),
          (this_or_next|neg|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),

          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),

          #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", curse, ":power", 15),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, slow),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 15),
          (assign,":max_damage",100),
        (try_end),
    ])]
   
cast_magic_steed_of_shadows = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      #(assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",100),
        (store_mul,":range_add",":power", 100),
        (val_add,":max_range",":range_add"),
      (try_end),
      
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_magic_curse_small", pos6, 3),
      (copy_position,pos51,pos5),
      (call_script, "script_cf_agent_steed_of_shadows", ":shooter", ":max_range", ":power"),
    ])]
   
cast_magic_penumbral_pendulum = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":damage",70),
        (store_random_in_range, ":randon_damage", 40, 61),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (store_add,":damage",":damage_add"),
        (val_add,":power",5),
      (try_end),
      
      (call_script, "script_cf_agent_magic_penumbral_pendulum", ":shooter", ":power", ":damage"),
    ])]
   
cast_magic_spirit_leech = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                        
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 10),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_8"),
        (val_add,":max_range",":range_add"),
        (val_mul,":spec_power",":power", 2),
      (try_end),
      
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (try_begin),
            (eq, ":player",":shooter"),
            (agent_get_slot, ":target", ":player", slot_agent_player_target),
          (else_try),
            (agent_ai_get_look_target, ":target", ":shooter"),
          (try_end),
          (gt,":target",0),
          (agent_is_alive,":target"),
          (neg|eq, ":player",":target"),
          (assign,":victim",":target"),
        (try_end),
        (try_begin),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
      (assign, ":num_hit", 1),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_poison_cloud", pos5, 30),
      (else_try), 
        (gt,":damage",0),
        (particle_system_burst, "psys_poison_cloud", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", curse, ":spec_power", 15),
        (val_add, ":num_hit", 1),
      (try_end),
      
      (store_agent_hit_points, ":hp", ":shooter",1),
      (store_mul,":spec_power",":num_hit", 10),
      (val_add, ":hp", ":spec_power"),
      (agent_set_hit_points, ":shooter", ":hp",1),
      
    ])]


cast_magic_doom_and_darkness = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (call_script, "script_cf_agent_play_sound_by_voice_type", ":shooter", voice_warcry),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",80),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 80),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_fear_effect", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_fear_effect", pos5, 5),
      (try_end),
      
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        (agent_get_slot, ":special", ":agent", slot_agent_special_ability_affect_type),
        (neg|eq,":special", berserk),
        (neg|eq,":special", stoneskin),
        (neg|eq,":special", battlecry),
        (neg|eq,":special", holy_light),

        (agent_get_slot, ":agent_courage_score", ":agent",  slot_agent_courage_score),
        (val_add, ":agent_courage_score", ":max_damage"),
        (agent_set_slot, ":agent", slot_agent_courage_score, ":agent_courage_score"),     
        (call_script, "script_decide_run_away_or_not", ":agent", 100),

        (agent_play_sound,":agent","snd_fear"),
        (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, fright_aura),
        (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 30),

      (try_end),
    ])]

cast_magic_gaze_of_nagash = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 150),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":dest_damage",":power", 100),
      (try_end),
      

      (copy_position,pos6,pos5),
      (particle_system_burst, "psys_Freezing_Trail", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", curse, ":power", ":power"),
        
        (agent_get_troop_id, ":inflicted_troop", ":agent"),
        (store_skill_level, ":defence", skl_magic_defence, ":inflicted_troop"),
        (le,":defence",5),
        (troop_get_slot, ":inflicted_troop_max_hp", ":inflicted_troop", slot_troop_max_hp),
            
        (store_random_in_range, ":random_no", 0, ":inflicted_troop_max_hp"),
        (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 1),
            
        (this_or_next|ge,":random_no", ":inflicted_agent_hp"),
        (ge, ":dest_damage", ":inflicted_troop_max_hp"),
        (agent_set_hit_points,":agent",0,0),
        (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
      (try_end),
    ])]

cast_magic_ryze_the_grave_call = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":number",5),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      (val_add,":power",1),
        (val_mul,":number",2),
        (store_mul,":number_2",":number", -1),
        (val_add,":number_2",1),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
        
        (try_for_range,":unused",0,":power"),
          (copy_position,pos51,pos5),
          (store_random_in_range, ":posx", ":number_2",":number"),
          (store_random_in_range, ":posy", ":number_2",":number"),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (position_move_x,pos51,":posx"),
          (position_move_y,pos51,":posy"),
          (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
          (ge, ":stamina", 5),
          (val_sub, ":stamina", 5),
          (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
          (store_random_in_range, ":r", 0, 3),
          (try_begin),
            (eq, ":r", 0),
            (store_random_in_range, ":spawn_troop_id", "trp_draugr_3", "trp_dullahan"),
          (else_try),
            (store_random_in_range, ":spawn_troop_id", "trp_skeleton_spearman", "trp_skeleton_cav"),
          (try_end),
          (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", 1),
        (try_end),
    ])]
    
cast_magic_summon_Zombie_Lord = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":number",10),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
      
      (val_add,":power",1),
      (val_mul,":number",2),
      (store_mul,":number_2",":number", -1),
      (val_add,":number_2",1),
        (try_for_range,":unused",0,":power"),
          (copy_position,pos51,pos5),
          (store_random_in_range, ":posx", ":number_2",":number"),
          (store_random_in_range, ":posy", ":number_2",":number"),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (position_move_x,pos51,":posx"),
          (position_move_y,pos51,":posy"),
          (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
          (ge, ":stamina", 5),
          (val_sub, ":stamina", 5),
          (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
          (store_random_in_range, ":r", 0, 5),
          (assign,":number",1),
          (try_begin),
            (eq, ":r", 0),
            (assign, ":spawn_troop_id", "trp_zombie_5"),
          (else_try),
            (assign, ":spawn_troop_id", "trp_zombie_3"),
          (try_end),
          (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", 1),
        (try_end),
      (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", "trp_zombie_6", 1),
    ])]
    
cast_magic_doom_bolt = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (this_or_next|eq,":weapon","itm_ebony_bow"),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",50),
        (assign,":damage",200),
        (store_random_in_range, ":randon_damage", 80, 121),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (val_div,":max_range"),
        (store_mul,":dest_damage",":power", 100),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_arcane_explosion", pos6, 5),
       
      (copy_position,pos51,pos5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        
        (agent_get_troop_id, ":inflicted_troop", ":agent"),
        (store_skill_level, ":defence", skl_magic_defence, ":inflicted_troop"),
        (le,":defence",5),
        (troop_get_slot, ":inflicted_troop_max_hp", ":inflicted_troop", slot_troop_max_hp),
            
        (store_random_in_range, ":random_no", 0, ":inflicted_troop_max_hp"),
        (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 1),
            
        (this_or_next|ge,":random_no", ":inflicted_agent_hp"),
        (ge, ":dest_damage", ":inflicted_troop_max_hp"),
        (agent_set_hit_points,":agent",0,0),
        (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
      (try_end),
    ])]

cast_magic_power_of_darkness = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_power_of_darkness", ":max_range", 40),
    ])]

cast_magic_word_of_pain = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",70),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 70),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, "itm_magic_word_of_pain"),
        (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 15),
      (try_end),
    ])]

cast_magic_apotheosis = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":heal",0),
      (gt,":weapon",0),
      
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",100),
        (assign,":heal",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 10),
        (val_add,":max_range",":range_add"),
        (val_add,":heal",":damage_add"),
      (try_end),
      
        (try_for_agents,":possable_agent"),
          (gt,":heal",0),
          (agent_is_alive,":possable_agent"),
          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),
          (try_begin),
            (this_or_next|agent_is_ally,":shooter"),
            (neg|agent_is_ally,":agent"),
            (this_or_next|agent_is_ally,":agent"),
            (neg|agent_is_ally,":shooter"),

            (store_agent_hit_points, ":hp", ":agent",1),
            (val_add, ":hp", ":heal"),
            (agent_set_hit_points, ":agent", ":hp",1),
            (position_move_z,pos3,100),
            (particle_system_burst, "psys_heal_effect", pos3, 30), 
          (else_try),
            (this_or_next|agent_is_ally,":shooter"),
            (agent_is_ally,":agent"),
            (this_or_next|neg|agent_is_ally,":agent"),
            (neg|agent_is_ally,":shooter"),
            (agent_get_slot, ":special", ":agent", slot_agent_special_ability_affect_type),
            (neg|eq,":special", berserk),
            (neg|eq,":special", stoneskin),
            (neg|eq,":special", battlecry),
            (neg|eq,":special", holy_light),

            (agent_play_sound,":agent","snd_fear"),
            (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, fright_aura),
            (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 30),
          (try_end),  
        (try_end),
    ])]
   
cast_magic_soul_quench = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (this_or_next|eq,":weapon","itm_ebony_bow"),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",200),
        (store_random_in_range, ":randon_damage", 50, 75),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_Burning_Trail_holy",pos5,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_Burning_Trail_holy",pos5,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
        (try_end),
      (try_end),
    ])]

cast_magic_hand_of_glory = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_hand_of_glory", ":max_range", 40),
    ])]

cast_magic_frostblade = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_frostblade", ":max_range", 40),
    ])]

cast_magic_shield_of_cold = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),

      (try_begin),
        (copy_position,pos6,pos51),
        (position_move_z,pos6,300),
        (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_end),
      (call_script, "script_cf_agent_cast_buff", ":shooter", "itm_magic_shield_of_cold", ":max_range", 40),
    ])]


   
cast_magic_arcane_unforging = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      

      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                    
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",200),
        (store_random_in_range, ":randon_damage", 80, 161),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_arcane_explosion", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_special_ability_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_special_ability_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_special_ability_extra_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_special_ability_extra_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_special_ability_passiv_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_special_ability_passiv_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_spell_1_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_spell_1_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_spell_2_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_spell_2_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_spell_3_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_spell_3_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_spell_4_cooldown),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_spell_4_cooldown, ":timer_2"),
        (agent_get_slot, ":timer_2", ":agent", slot_agent_shield_bash_timer),
        (val_add, ":timer_2", 30),
        (agent_set_slot, ":agent", slot_agent_shield_bash_timer, ":timer_2"),
        (assign,":max_damage",":damage_add"),
      (try_end),
    ])]

cast_magic_mana_tempest = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      (assign,":damage",0),
            
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 2),
        (val_add,":range",":range_add"),
        (val_add,":damage",1),
      (try_end),
              
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),

        
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (eq,":victim",-1),
          
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
                              
          (agent_get_position, pos2, ":agent"),
          (get_distance_between_positions,":distance",pos2,pos5),
          (le,":distance",":range"),
          (call_script, "script_agent_get_num_companion_nearby", ":agent", 400),
          (assign, ":num_enemies", reg0),
          (this_or_next|le, ":num_enemies", 1),
          (ge, ":num_enemies", 6),
          (assign,":victim",":agent"),
        (try_end),
        
        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        (copy_position,pos4,pos5),
        (try_for_range,":posz",0,":damage"),
          (val_mul,":posz",500),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_mana_tempest_dummy", 0),
        (try_end),
    ])]
    
cast_magic_mana_tempest_2 = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      
      (assign,":max_damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (assign, ":cost_stamina", 20),
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
        (store_div,":spec_time",":power", 3),
        (val_add,":spec_time",2),
      (try_end),

      (particle_system_burst, "psys_incediary_cloud", pos5, 10),
      (position_set_z_to_ground_level, pos5),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (position_set_z_to_ground_level, pos3),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, "itm_magic_mana_tempest"),
        (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 5),
        (agent_set_slot, ":agent", slot_agent_is_fly, 0),
        
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", thunder, ":spec_power", ":spec_time"),
      (try_end),
    ])]
        
cast_magic_LightningBolt = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 60),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (val_add,":max_range",":range_add"),
          (val_add,":max_range",":damage_add"),
        (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
        (particle_system_burst, "psys_spark_explosion_small", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (else_try),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
          (assign,":max_damage",100),
        (try_end),
      (try_end),
    ])]

cast_magic_lightning = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                        
      (try_begin),
        (assign,":max_range",120),
        (assign,":damage",100),
        (store_random_in_range, ":randon_damage", 25, 101),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (try_begin),
            (eq, ":player",":shooter"),
            (agent_get_slot, ":target", ":player", slot_agent_player_target),
          (else_try),
            (agent_ai_get_look_target, ":target", ":shooter"),
          (try_end),
          (gt,":target",0),
          (agent_is_alive,":target"),
          (neg|eq, ":player",":target"),
          (assign,":victim",":target"),
        (try_end),
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),

        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
      
      
      #(position_move_z,pos5,100),
      (try_begin),
        (gt,":damage",0),
        (particle_system_burst, "psys_thunder", pos5, 1),
        (play_sound_at_position, "snd_thunder_hit", pos5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", 15),
        #(agent_set_slot, ":agent", slot_agent_special_damage_type, poison),
        #(agent_set_slot, ":agent", slot_agent_special_damage_time, 15),
      (try_end),

    ])]


cast_magic_fire_ray_dummy = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      
      (assign,":damage",0),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (assign, ":cost_stamina", 1),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (assign, ":cost_stamina", 0),
      (try_end),
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
      
      (try_begin),
        (assign,":max_range",150),
        (assign,":damage",50),
        (store_mul,":damage_add",":power", 50),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":range_add",":power", 20),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", 5),
      (try_end),
    ])]
        
cast_magic_fire_ray = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      
      (assign,":damage",0),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",150),
        (assign,":damage",50),
        (store_mul,":damage_add",":power", 50),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":range_add",":power", 20),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Burning_Trail", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", 5),
        (assign,":damage",65),
      (try_end),
    ])]
        
        
cast_magic_fire_ball = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (this_or_next|eq,":weapon","itm_ebony_bow"),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",200),
        (store_random_in_range, ":randon_damage", 50, 75),
        (store_mul,":range_add",":power", 60),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),
      (try_end),
       
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
        (try_end),
        
        #(call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", ice, 1, 15),
      (try_end),
    ])]

cast_magic_fire_ball_2 = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                
      
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",150),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 60),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),

        (store_mul,":add_missile",":power", 1),
        (val_add,":add_missile",1),
      (try_end),
      
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (val_mul,":add_missile",2),
        (try_end),
        
      (position_get_distance_to_ground_level, ":distance", pos5),
      (try_begin),
        (lt, ":distance", 0),
        (position_set_z_to_ground_level, pos5),
        (position_move_z, pos5, 200),
      (try_end),                
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_explosive_explosion_sparks_b", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":spec_power", ":power"),
      (try_end),
      
      
      (play_sound_at_position, "snd_cannon_shot", pos5),          
      (position_move_z, pos5, 150),
      (try_for_range, ":unused", 0, ":add_missile"),
        (copy_position, pos2, pos5),
        (store_random_in_range, ":x_offset", 1, 361),#Random Rotation of X
        (position_rotate_x, pos2, ":x_offset"),    
        (store_random_in_range, ":y_offset", 1, 361),#Random Rotation of Y
        (position_rotate_y, pos2, ":y_offset"),    
        (store_random_in_range, ":z_offset", -10, 11),#Random Rotation of Z
        (position_rotate_z, pos2, ":z_offset"),   
        (set_fixed_point_multiplier,10),
        (add_missile, ":shooter", pos2, 80, ":weapon", 0, "itm_magic_poison_dummy", 0),
      (try_end),    
    ])]
    
    
cast_magic_fire_ball_3 = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      
      #(this_or_next|item_has_property,":weapon",itp_type_crossbow),
      #(item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                     
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 30),
        (store_mul,":damage_add",":power", 50),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_add,":max_damage",":damage_add"),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
         (particle_system_burst,"psys_bomb_fire_1",pos5,35),
         (particle_system_burst,"psys_Burning_Trail",pos5,50),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
         (particle_system_burst,"psys_bomb_fire_1",pos5,5),
         (particle_system_burst,"psys_Burning_Trail",pos5,5),
      (try_end),
            
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", burn, ":power", 10),
         (try_begin),
           (neg|agent_is_human,":agent"),
           (agent_set_animation,":agent","anim_horse_rear"), 
           (agent_play_sound,":agent","snd_metal_hit_high_armor_high_damage"),
           (agent_deliver_damage_to_agent,":shooter",":agent"),
         (try_end),
      (try_end),
    ])]

cast_magic_Pyroblast = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",200),

        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
        (store_div,":spec_time",":power", 3),
        (val_add,":spec_time",2),
      (try_end),
         
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
              
      (copy_position,pos6,pos5),
      (position_move_z,pos6,150),
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,50),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 35),
        (particle_system_burst, "psys_incediary_cloud", pos5, 35),
      (else_try),  
        (gt,":damage",0),
        (gt,":power",0),
        (particle_system_burst, "psys_flame_explosion",pos5,5),
        (particle_system_burst, "psys_explosive_explosion_sparks_a", pos5, 5),
        (particle_system_burst, "psys_incediary_cloud", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_4"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", severe_burn, ":spec_power", ":spec_time"),        
        (try_end),
        
        
        (val_add,":spec_time",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", severe_burn, ":spec_power", ":spec_time"),        
      (try_end),
    ])]

cast_magic_apocalypse = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      (assign,":damage",0),
      
      (try_begin),
        (store_mul,":damage",":power", 6),
        (val_add,":damage",5),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (val_add,":range",":range_add"),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_mul, ":damage", 4),
        (val_add,":range",":range_add"),
      (try_end),
      
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),

        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
      
        (try_for_range,":unused",0,":damage"),
          (copy_position,pos4,pos5),
          (store_random_in_range, ":posx", -25,26),
          (store_random_in_range, ":posy", -25,26),
          (store_random_in_range, ":posz", 30,70),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (val_mul,":posz",100),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          #(position_move_z,pos5,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_fire_ray_dummy", 0),
          (try_begin),
            (eq, "$g_weapon_fire_particle", 0),
            (gt,":damage",0),
            (particle_system_burst, "psys_incediary_cloud", pos4, 5),
          (else_try),  
            (gt,":damage",0),
            (particle_system_burst, "psys_incediary_cloud", pos4, 1),
          (try_end),
          (try_for_agents,":possable_agent"),
            (gt,":damage",0),
            (gt,":power",0),
            (agent_is_alive,":possable_agent"),
            (this_or_next|agent_is_ally,":shooter"),
            (agent_is_ally,":possable_agent"),
            (this_or_next|neg|agent_is_ally,":possable_agent"),
            (neg|agent_is_ally,":shooter"),

            (agent_get_position,pos3,":possable_agent"),
            (get_distance_between_positions,":dist",pos4,pos3),
            (le,":dist",250),
            (assign,":agent",":possable_agent"),
            (val_add,":power",-1),
            (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", 200, severe_burn, ":power", 5),
          (try_end),
        (try_end),
    ])]

cast_magic_incediary_cloud = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      (assign,":damage",0),
      
      
      (try_begin),
        (eq, ":weapon", "itm_pit_lord_sword"),
        (val_add,":power",3),
      (try_end),
      
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",1),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (val_mul,":damage",2),
      (try_end),
        
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),

        
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (eq,":victim",-1),
          
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
                              
          (agent_get_position, pos2, ":agent"),
          (get_distance_between_positions,":distance",pos2,pos5),
          (le,":distance",":range"),
          (call_script, "script_agent_get_num_companion_nearby", ":agent", 400),
          (assign, ":num_enemies", reg0),
          (this_or_next|le, ":num_enemies", 1),
          (ge, ":num_enemies", 6),
          (assign,":victim",":agent"),
        (try_end),
        
        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        (copy_position,pos4,pos5),
        (try_for_range,":posz",0,":damage"),
          (store_random_in_range, ":posx", -2,3),
          (store_random_in_range, ":posy", -2,3),
          (val_mul,":posx",20),
          (val_mul,":posy",20),
          (val_mul,":posz",500),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_incediary_cloud_dummy", 0),
        (try_end),
    ])]
    
cast_magic_incediary_cloud_2 = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      
      (assign,":max_damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (assign, ":cost_stamina", 20),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_4"),
        (assign, ":cost_stamina", 10),
      (try_end),
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
      
      (try_begin),
        (eq, ":weapon", "itm_pit_lord_sword"),
        (val_add,":power",3),
      (try_end),
      
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 40),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_div,":spec_power",":power", 2),
        (val_add,":spec_power",1),
        (store_div,":spec_time",":power", 3),
        (val_add,":spec_time",2),
      (try_end),


      (particle_system_burst, "psys_incediary_cloud", pos5, 10),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),

        #(agent_set_slot, ":agent", slot_agent_special_damage_type, severe_burn),
        #(agent_set_slot, ":agent", slot_agent_special_damage_time, 3),
        
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", severe_burn, ":spec_power", ":spec_time"),
      (try_end),
    ])]
        
cast_magic_Entangling = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),

      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",100),
        (store_mul,":range_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_mul,":spec_time",":power", 5),
      (try_end),
              
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),


        (try_for_agents,":possable_agent"),
          (agent_is_active,":possable_agent"),
          (agent_is_alive,":possable_agent"),   
          (agent_get_position,pos6,":possable_agent"),
          (get_distance_between_positions,":dist",pos5,pos6),
          (lt,":dist",":max_range"),            	
          (try_begin),
            (neg|agent_is_human, ":possable_agent"),#stop if not human
            (agent_get_rider,":rider_agent",":possable_agent"),
            (assign, ":continue", 0),
            (try_begin),
              (gt,":rider_agent",-1),
              (agent_is_ally, ":rider_agent"),
              (neg|agent_is_ally, ":shooter"),
              (assign, ":continue", 1),
            (else_try),
              (gt,":rider_agent",-1),
              (neg|agent_is_ally, ":rider_agent"),
              (agent_is_ally, ":shooter"),
              (assign, ":continue", 1),
            (else_try),
              (le,":rider_agent",-1),
              (assign, ":continue", 1),
            (try_end),
            (eq, ":continue", 1),
            (agent_get_rider,":rider_agent",":possable_agent"),
            (try_begin),
              (gt,":rider_agent",-1),
              (agent_set_animation, ":rider_agent", "anim_bash_knocked"),  
              (agent_set_slot, ":rider_agent", slot_agent_special_ability_affect_type, entangle),
              (agent_set_slot, ":rider_agent", slot_agent_special_ability_affect_time, ":spec_time"),
              (agent_set_hit_points,":possable_agent",0,0),
              (agent_deliver_damage_to_agent,":shooter",":possable_agent"),
            (else_try),
              (agent_set_hit_points,":possable_agent",0,0),
              (agent_deliver_damage_to_agent,":shooter",":possable_agent"),
            (try_end),
          (else_try),
            (assign, ":continue", 0),
            (try_begin),
              (agent_is_ally, ":possable_agent"),
              (neg|agent_is_ally, ":shooter"),
              (assign, ":continue", 1),
            (else_try),
              (neg|agent_is_ally, ":possable_agent"),
              (agent_is_ally, ":shooter"),
              (assign, ":continue", 1),
            (try_end),
            (eq, ":continue", 1),
            (agent_is_human, ":possable_agent"),
            (position_move_z, pos6, 200),
            (particle_system_burst,"psys_stun_effect",pos6,1),
            (agent_set_animation, ":possable_agent", "anim_bash_knocked"),  
            (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_type, entangle),
            (agent_set_slot, ":possable_agent", slot_agent_special_ability_affect_time, ":spec_time"),
        (try_end),
    ])]


cast_magic_black_hold_long = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                                
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 4),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),
              
        (assign,":victim",-1),        
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
      (try_begin),
        (get_player_agent_no,":player"),
        (eq,":shooter",":player"),
        (eq, "$skill_mask_start", 1),
        (key_is_down, key_left_shift),
        (assign,":victim",-2),
      (try_end),
        
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (eq,":victim",-1),
          
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
                              
          (agent_get_position, pos2, ":agent"),
          (get_distance_between_positions,":distance",pos2,pos5),
          (le,":distance",":range"),
          (call_script, "script_agent_get_num_companion_nearby", ":agent", 400),
          (assign, ":num_enemies", reg0),
          (this_or_next|le, ":num_enemies", 1),
          (ge, ":num_enemies", 6),
          (assign,":victim",":agent"),
        (try_end),
        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        (copy_position,pos4,pos5),
        (try_for_range,":posz",0,":damage"),
          (try_begin),
            (store_add,":max_damage",":posz",1),
            (ge,":max_damage",":damage"),
            (val_add,":max_damage",1),
            (val_mul,":max_damage",500),
            (position_move_z,pos4,":max_damage"),
            (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_arcane_orb", 0),
          (try_end),
          (val_mul,":posz",500),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_black_hold_2", 0),
        (try_end),
    ])]
    
cast_magic_black_hold = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      

      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (assign, ":cost_stamina", 25),
      
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
              
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_random_in_range, ":randon_damage", 40, 61),
        (store_mul,":range_add",":power", 100),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
            
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_black_hold", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (agent_get_horse, ":target_horse", ":agent"),
        (try_begin),
          (gt, ":target_horse", 0),
          (agent_set_position, ":target_horse", pos5),
          (agent_set_animation, ":target_horse", "anim_horse_rear"),
        (else_try),
          (agent_set_position, ":agent", pos5),
        (try_end),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":power", ":power"),
        (assign,":max_damage",":damage_add"),
      (try_end),
    ])]
   
cast_magic_summon_undead = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":spawn_troop_id",0),
      (assign,":number",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
            
      (store_character_level,":troop_level",":shooter_troop"),
      (val_mul,":power",5),
      (val_add,":power",":troop_level"),
      (try_begin),
        (ge, ":power", 60),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",3),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_draugr_lord"),
          (assign,":number",2),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_wight"),
        (else_try),
          (assign,":spawn_troop_id","trp_dullahan"),
        (try_end),
      (else_try),
        (ge, ":power", 45),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_draugr_lord"),
          (assign,":number",1),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_wight"),
        (else_try),
          (assign,":spawn_troop_id","trp_dullahan"),
        (try_end),
      (else_try),
        (ge, ":power", 30),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_dullahan"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_skeleton_lord"),
        (else_try),
          (assign,":spawn_troop_id","trp_draugr_3"),
        (try_end),
      (else_try),
        (ge, ":power", 15),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_draugr_2"),
        (else_try),
          (ge, ":r", 4),
          (assign,":spawn_troop_id","trp_skeleton_warrior"),
          (assign,":number",1),
        (else_try),
          (assign,":spawn_troop_id","trp_zombie_2"),
        (try_end),
      (else_try),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
          (try_begin),
            (ge, ":r", 8),
            (assign,":spawn_troop_id","trp_draugr_1"),
          (else_try),
            (ge, ":r", 5),
            (assign,":spawn_troop_id","trp_se_billman_1"),
          (else_try),
            (assign,":spawn_troop_id","trp_zombie_1"),
          (try_end),
      (try_end),
      
      (try_begin),
        (eq, ":shooter_troop", "trp_mummy_3"),
        (assign,":spawn_troop_id","trp_mummy_2"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_adventurer_troop_15"),
        (assign,":spawn_troop_id","trp_demon_8"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_adventurer_troop_1"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_wight"),
        (else_try),
          (assign,":spawn_troop_id","trp_ghost"),
          (assign,":number",4),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_polish_which_1"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 6),
          (assign,":spawn_troop_id","trp_air_elemental"),
        (else_try),
          (assign,":spawn_troop_id","trp_ghost"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (eq, ":shooter_troop", "trp_polish_which_2"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",1),
        (try_begin),
          (ge, ":r", 5),
          (assign,":spawn_troop_id","trp_demon_4"),
        (else_try),
          (assign,":spawn_troop_id","trp_wight"),
          (assign,":number",2),
        (try_end),
      (else_try),
        (this_or_next|eq,":weapon","itm_dragonpriest_staff_1"),
        (this_or_next|eq, ":shooter_troop", "trp_lich_3"),
        (eq, ":shooter_troop", "trp_knight_10_14"),
        (assign,":spawn_troop_id","trp_draugr_lord"),
        (assign,":number",2),
      (else_try),
        (eq, ":shooter_troop", "trp_mummy_4"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 9),
          (assign,":spawn_troop_id","trp_werewolf_1_a"),
          (assign,":number",1),
        (else_try),
          (ge, ":r", 7),
          (assign,":spawn_troop_id","trp_werewolf_1"),
        (else_try),
          (ge, ":r", 5),
          (assign,":spawn_troop_id","trp_mummy_2_1"),
        (else_try),
          (assign,":spawn_troop_id","trp_mummy_2"),
        (try_end),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_9"),
        (store_random_in_range, ":r", 0, 10),
        (assign,":number",2),
        (try_begin),
          (ge, ":r", 8),
          (assign,":spawn_troop_id","trp_mummy_4"),
        (else_try),
          (ge, ":r", 5),
          (assign,":spawn_troop_id","trp_werewolf_1_a"),
        (else_try),
          (assign,":spawn_troop_id","trp_mummy_3"),
        (try_end),
      (else_try),
        (agent_has_item_equipped,":shooter","itm_magic_book_6"),
        (store_random_in_range, ":ran", 0, 8),
        (assign,":number",1),
        (try_begin),
          (eq,":ran",0),
          (assign,":spawn_troop_id","trp_lich_2"),
        (else_try),  
          (eq,":ran",1),
          (assign,":spawn_troop_id","trp_ghost_dragon"),
        (else_try),  
          (eq,":ran",2),
          (assign,":spawn_troop_id","trp_lich_dragon"),
        (else_try),  
          (eq,":ran",3),
          (assign,":spawn_troop_id","trp_wraith"),
        (else_try),  
          (eq,":ran",4),
          (assign,":spawn_troop_id","trp_death"),
        (else_try),  
          (eq,":ran",5),
          (assign,":spawn_troop_id","trp_bone_dragon"),
          (assign,":number",2),
        (else_try),  
          (eq,":ran",6),
          (assign,":spawn_troop_id","trp_draugr_lord"),
        (else_try),  
          (eq,":ran",7),
          (assign,":spawn_troop_id","trp_mummy_3"),
        (try_end),  
      (try_end),
      
      
      (gt,":spawn_troop_id",0),
      (gt,":number",0),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
        
        (copy_position, pos51, pos5),
        (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", ":number"),
    ])]
    

cast_magic_death_cloud = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                                
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
        (val_mul,":damage",2),
      (try_end),
              
        (assign,":victim",-1),        
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),
        
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (eq,":victim",-1),
          
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
                              
          (agent_get_position, pos2, ":agent"),
          (get_distance_between_positions,":distance",pos2,pos5),
          (le,":distance",":range"),
          (call_script, "script_agent_get_num_companion_nearby", ":agent", 400),
          (assign, ":num_enemies", reg0),
          (this_or_next|le, ":num_enemies", 1),
          (ge, ":num_enemies", 6),
          (assign,":victim",":agent"),
        (try_end),

        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        (copy_position,pos4,pos5),
        (try_for_range,":posz",0,":damage"),
          (store_random_in_range, ":posx", -2,3),
          (store_random_in_range, ":posy", -2,3),
          (val_mul,":posx",20),
          (val_mul,":posy",20),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
        (val_mul,":posx",5),
        (val_mul,":posy",5),
      (try_end),
          (val_mul,":posz",500),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_death_cloud_dummy", 0),
        (try_end),
    ])]
    
cast_magic_death_cloud_2 = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      
      (assign,":max_damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
           
      (assign, ":cost_stamina", 15),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
        (assign, ":cost_stamina", 5),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_8"),
        (assign, ":cost_stamina", 5),
      (try_end),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_9"),
        (assign, ":cost_stamina", 5),
      (try_end),
      
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
        (particle_system_burst, "psys_death_cloud", pos5, 10),
        (agent_play_sound,":shooter","snd_death_cld"),
      
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_8"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", power_poison, ":spec_power", ":power"),
      (else_try),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", poison, ":spec_power", ":power"),
      (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_9"),
          (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 0),
          (store_mul,":dead_power",":power", 5),
          (ge, ":dead_power", ":inflicted_agent_hp"),
          (agent_set_hit_points,":agent",0,0),
          (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
        (try_end),
        
      (try_end),
    ])]
    
cast_magic_deep_freeze = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      

      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                    
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
            
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (val_mul,":max_damage",2),
        (val_add,":max_range",":range_add"),
      (try_end),
            
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 10),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", ":power"),
        (assign,":max_damage",":damage_add"),
        
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 0),
        (store_mul,":dead_power",":power", 5),
        (ge, ":dead_power", ":inflicted_agent_hp"),
        (agent_set_hit_points,":agent",0,0),
        (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
      (try_end),
        
        
      (try_end),
    ])]

cast_magic_summon_blade = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":number",10),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_necromancy, ":shooter_troop"),
      (val_add,":power",1),
        (val_mul,":number",2),
        (store_mul,":number_2",":number", -1),
        (val_add,":number_2",1),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
        
        (try_for_range,":unused",0,":power"),
          (copy_position,pos51,pos5),
          (store_random_in_range, ":posx", ":number_2",":number"),
          (store_random_in_range, ":posy", ":number_2",":number"),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (position_move_x,pos51,":posx"),
          (position_move_y,pos51,":posy"),
          (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
          (ge, ":stamina", 5),
          (val_sub, ":stamina", 5),
          (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
          (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", "trp_mercenaries_end", 1),
        (try_end),
    ])]
    
cast_magic_soul_Leech = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (copy_position,pos51,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      
      (assign,":max_damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
           
      (assign, ":num_hit", 1),
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (assign,":heal",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
        (val_add,":heal",":damage_add"),
      (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_8"),
          (val_add,":max_range",":range_add"),
        (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_9"),
          (val_add,":max_range",":range_add"),
        (try_end),
      
        (particle_system_burst, "psys_death_cloud_blue", pos5, 10),
        (agent_play_sound,":shooter","snd_death_cld"),
        (store_div,":half_damage",":max_damage",2),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", curse, ":spec_power", ":power"),
        (val_add, ":num_hit", 1),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_9"),
          (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 0),
          (store_mul,":dead_power",":power", 5),
          (ge, ":dead_power", ":inflicted_agent_hp"),
          (agent_set_hit_points,":agent",0,0),
          (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
        (try_end),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_8"),
          (store_agent_hit_points, ":hp", ":agent"),
          (le, ":hp", 5),
          (store_random_in_range, ":r", 0, 2),
          (try_begin),
            (eq, ":r", 0),
            (store_random_in_range, ":spawn_troop_id", "trp_zombie_1", "trp_skeleton_spearman"),
          (else_try),
            (store_random_in_range, ":spawn_troop_id", "trp_draugr_1", "trp_mummy_2_1"),
          (try_end),
          (call_script,"script_cf_agent_spawn_agent_to_pos51", ":shooter", ":spawn_troop_id", 1),
        (try_end),
        
      (try_end),
        
      (store_agent_hit_points, ":hp", ":shooter"),
      (store_mul,":spec_power",":num_hit", 25),
      (val_add, ":hp", 50),
      (val_add, ":hp", ":spec_power"),
      (agent_set_hit_points, ":shooter", ":hp"),
        
      (agent_get_position,pos6,":shooter"),
      (try_for_agents,":possable_agent"),
          (gt,":num_hit",0),
          (agent_is_alive,":possable_agent"),

          (this_or_next|agent_is_ally,":shooter"),
          (neg|agent_is_ally,":possable_agent"),
          (this_or_next|agent_is_ally,":possable_agent"),
          (neg|agent_is_ally,":shooter"),


          (agent_get_position,pos3,":possable_agent"),
          (get_distance_between_positions,":dist",pos6,pos3),
          (le,":dist",":max_range"),
          (assign,":agent",":possable_agent"),
          (val_add, ":num_hit", -1),
          (store_agent_hit_points, ":hp", ":agent"),
          (val_add, ":hp", ":heal"),
          (agent_set_hit_points, ":agent", ":hp"),
          (position_move_z,pos3,100),
          (particle_system_burst, "psys_heal_effect", pos3, 30), 
      (try_end),
      
      
    ])]
    
   
cast_magic_Dispel_Magic = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (assign,":max_range",100),
        (store_mul,":range_add",":power", 50),
        (val_add,":max_range",":range_add"),
      (try_end),
      
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_frost_nails", pos6, 5),
      (try_for_agents,":possable_agent"),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (agent_get_slot, ":special", ":agent", slot_agent_special_ability_affect_type),
        (assign, ":continue", 0),
        (try_begin),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),      
          (this_or_next|eq,":special", divine_strength),
          (this_or_next|eq,":special", haste),
          (this_or_next|eq,":special", regeneration),
          (this_or_next|eq,":special", haste_reload),
          (this_or_next|eq,":special", berserk),
          (this_or_next|eq,":special", battlecry),
          (this_or_next|eq,":special", inspire),
          (agent_slot_ge, ":agent", slot_agent_spawned, 1), 
          (assign, ":continue", 1),
        (else_try),
          (this_or_next|agent_is_ally,":shooter"),
          (neg|agent_is_ally,":agent"),
          (this_or_next|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
          (this_or_next|eq,":special", weakness),
          (this_or_next|eq,":special", slow),
          (this_or_next|eq,":special", mummy_curse),
          (this_or_next|eq,":special", entangle),
          (this_or_next|eq,":special", warcry),
          (this_or_next|eq,":special", grasp),
          (this_or_next|eq,":special", fright_aura),
          (agent_slot_ge, ":agent", slot_agent_special_damage_time, 1), 
          (assign, ":continue", 2),
        (try_end),
        (ge, ":continue", 1),
        
        (agent_get_slot, ":special", ":agent", slot_agent_special_ability_affect_type),
        (try_begin),
          (eq, ":continue", 1),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, 0),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 0),
        (else_try),
          (eq, ":continue", 2),
          (neg|agent_slot_eq, ":agent", slot_agent_is_running_away, 0),
          (agent_stop_running_away, ":agent"),
          (agent_clear_scripted_mode,":agent"),
          (agent_set_slot, ":agent",  slot_agent_is_running_away, 0),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_type, 0),
          (agent_set_slot, ":agent", slot_agent_special_ability_affect_time, 0),
          (agent_set_slot, ":agent", slot_agent_special_damage_type, 0),
          (agent_set_slot, ":agent", slot_agent_special_damage_power, 0),
          (agent_set_slot, ":agent", slot_agent_special_damage_time, 0),
        (try_end),   
        (agent_play_sound, ":agent", "snd_spell_dispel"),
        (try_begin),
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),      
          (agent_slot_ge, ":agent", slot_agent_spawned, 1), 
          (agent_fade_out, ":agent"),
        (try_end),      
      (try_end),
    ])]

cast_magic_Frost_cloud = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                                
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",2),
      (try_end),
              
        (assign,":victim",-1),        
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
      (try_begin),
        (get_player_agent_no,":player"),
        (eq,":shooter",":player"),
        (eq, "$skill_mask_start", 1),
        (key_is_down, key_left_shift),
        (assign,":victim",-2),
      (try_end),
        
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (eq,":victim",-1),
          
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
                              
          (agent_get_position, pos2, ":agent"),
          (get_distance_between_positions,":distance",pos2,pos5),
          (le,":distance",":range"),
          (call_script, "script_agent_get_num_companion_nearby", ":agent", 400),
          (assign, ":num_enemies", reg0),
          (this_or_next|le, ":num_enemies", 1),
          (ge, ":num_enemies", 6),
          (assign,":victim",":agent"),
        (try_end),
        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        (copy_position,pos4,pos5),
        (copy_position,pos4,pos5),
        (try_for_range,":posz",0,":damage"),
          (store_random_in_range, ":posx", -2,3),
          (store_random_in_range, ":posy", -2,3),
          (val_mul,":posx",20),
          (val_mul,":posy",20),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_plague_staff_1"),
        (val_mul,":posx",5),
        (val_mul,":posy",5),
      (try_end),
          (val_mul,":posz",500),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_frost_cloud_dummy", 0),
        (try_end),
    ])]
    
cast_magic_Frost_cloudr = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      
      (assign,":max_damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
           
      (assign, ":cost_stamina", 15),

      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
            
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", 30),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 3),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (val_mul,":max_damage",2),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      
        (particle_system_burst, "psys_Ice_Storm", pos5, 10),

      
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (store_div,":half_damage",":max_damage",2),
        (store_random_in_range, ":damage", ":half_damage",":max_damage"),
        #(agent_deliver_damage_to_agent,":shooter",":agent", ":damage"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", freeze, ":spec_power", ":power"),
      (try_end),
    ])]
        
cast_magic_frozen_orb = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                
      
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_random_in_range, ":randon_damage", 50, 151),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":add_missile",":power", 3),
        (val_add,":add_missile",5),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_2"),
        (val_mul,":add_missile",2),
      (try_end),
      
      (position_get_distance_to_ground_level, ":distance", pos5),
      (try_begin),
        (lt, ":distance", 0),
        (position_set_z_to_ground_level, pos5),
        (position_move_z, pos5, 200),
      (try_end),                
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 50),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Ice_Storm", pos5, 5),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", ":power"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_2"),
          (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", ":power"),
        (try_end),
        (assign,":max_damage",":damage_add"),
      (try_end),
      
      (position_move_z, pos5, 200),
      (play_sound_at_position, "snd_cannon_shot", pos5),          
      (try_for_range, ":unused", 0, ":add_missile"),
        (copy_position, pos2, pos5),
        (store_random_in_range, ":x_offset", 1, 61),#Random Rotation of X
        (position_rotate_x, pos2, ":x_offset"),    
        (store_random_in_range, ":y_offset", 1, 361),#Random Rotation of Y
        (position_rotate_y, pos2, ":y_offset"),    
        (store_random_in_range, ":z_offset", 1, 361),#Random Rotation of Z
        (position_rotate_z, pos2, ":z_offset"),   
        (set_fixed_point_multiplier,10),
        (add_missile, ":shooter", pos2, 100, ":weapon", 0, "itm_magic_ice_ray_dummy", 0),
      (try_end),    
    ])]
    
cast_magic_blizzard = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      (assign,":damage",0),
      
      (try_begin),
        (store_mul,":damage",":power", 4),
        (val_add,":damage",5),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (val_add,":range",":range_add"),
      (try_end),
      
        (assign,":victim",-1),
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),


        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
      
        (try_for_range,":unused",0,":damage"),
          (copy_position,pos4,pos5),
          (store_random_in_range, ":posx", -15,16),
          (store_random_in_range, ":posy", -15,16),
          (store_random_in_range, ":posz", 30,70),
          (val_mul,":posx",50),
          (val_mul,":posy",50),
          (val_mul,":posz",100),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          #(position_move_z,pos5,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_ice_ray_dummy", 0),
          (try_begin),
            (eq, "$g_weapon_fire_particle", 0),
            (gt,":damage",0),
            (particle_system_burst, "psys_Ice_Storm", pos4, 5),
          (else_try),  
            (gt,":damage",0),
            (particle_system_burst, "psys_Ice_Storm", pos4, 1),
          (try_end),
          (try_for_agents,":possable_agent"),
            (gt,":damage",0),
            (gt,":power",0),
            (agent_is_alive,":possable_agent"),
            (this_or_next|agent_is_ally,":shooter"),
            (agent_is_ally,":possable_agent"),
            (this_or_next|neg|agent_is_ally,":possable_agent"),
            (neg|agent_is_ally,":shooter"),

            (agent_get_position,pos3,":possable_agent"),
            (get_distance_between_positions,":dist",pos4,pos3),
            (le,":dist",250),
            (assign,":agent",":possable_agent"),
            (val_add,":power",-1),
            (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", 200, freeze, ":power", 5),
          (try_end),
        (try_end),
    ])]
    
cast_magic_ice_ray_dummy = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      
      (assign,":damage",0),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (assign, ":cost_stamina", 3),
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (assign,":cost_stamina",1),
      (try_end),
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":damage_add",":power", 50),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":range_add",":power", 10),
        (val_add,":max_range",":range_add"),
      (try_end),
      
      (try_begin),
        (eq, "$g_weapon_fire_particle", 0),
        (gt,":damage",0),
        (particle_system_burst, "psys_Freezing_Trail", pos5, 15),
      (else_try),  
        (gt,":damage",0),
        (particle_system_burst, "psys_Freezing_Trail", pos5, 3),
      (try_end),
      (try_for_agents,":possable_agent"),
        (gt,":max_damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", 5),
      (else_try),  
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", 5),
      (try_end),
        
      (try_end),
    ])]

cast_magic_ice_ray = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
            
      (try_begin),
        (eq, ":weapon", "itm_warlock_staff_1"),
        (val_add,":power",1),
      (else_try),
        (eq, ":weapon", "itm_thunder_staff_1"),
        (val_add,":power",2),
      (try_end),
      
      (try_begin),
        (assign,":max_range",100),
        (assign,":damage",50),
        (store_mul,":range_add",":power", 20),
        (store_mul,":damage_add",":power", 100),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
      (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,200),
      (particle_system_burst, "psys_frost_nails", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", ":power"),
        
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", freeze, ":power", 5),
      (else_try),  
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", 5),
        (assign,":max_damage",50),
      (try_end),
        
      (try_end),
    ])]

cast_magic_DEADLY_COLD = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                  
      (try_begin),
        (assign,":max_range",200),
        (assign,":damage",100),
        (store_mul,":range_add",":power", 50),
        (store_mul,":damage_add",":power", 150),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":dest_damage",":power", 100),
      (try_end),
      
      (try_begin),
        (agent_has_item_equipped,":shooter","itm_magic_book_3"),
        (val_add,":max_range",":range_add"),
      (try_end),

      (copy_position,pos6,pos5),
      (particle_system_burst, "psys_Freezing_Trail", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (gt,":power",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", ice, ":power", ":power"),
        
        (agent_get_troop_id, ":inflicted_troop", ":agent"),
        (store_skill_level, ":defence", skl_magic_defence, ":inflicted_troop"),
        (try_begin),
          (agent_has_item_equipped,":shooter","itm_magic_book_3"),
          (val_add,":defence",-3),
        (try_end),
        (le,":defence",8),
        (troop_get_slot, ":inflicted_troop_max_hp", ":inflicted_troop", slot_troop_max_hp),
            
        (store_random_in_range, ":random_no", 0, ":inflicted_troop_max_hp"),
        (store_agent_hit_points, ":inflicted_agent_hp", ":agent", 1),
            
        (this_or_next|ge,":random_no", ":inflicted_agent_hp"),
        (ge, ":dest_damage", ":inflicted_troop_max_hp"),
        (agent_set_hit_points,":agent",0,0),
        (agent_deliver_damage_to_agent, ":shooter", ":agent", 100),
      (try_end),
    ])]


cast_magic_lightningball = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
      
      (assign, ":cost_stamina", 25),
      (try_begin),
        (agent_get_slot, ":stamina", ":shooter", slot_agent_mana),
        (ge, ":stamina", ":cost_stamina"),
        (val_sub, ":stamina", ":cost_stamina"),
        (agent_set_slot, ":shooter", slot_agent_mana, ":stamina"),
      (else_try),
        (assign, ":power", 0),
      (try_end),
            
      (try_begin),
        (assign,":max_range",300),
        (assign,":damage",100),
        (store_random_in_range, ":randon_damage", 10, 101),
        (store_mul,":range_add",":power", 40),
        (store_mul,":damage_add",":power", ":randon_damage"),
        (val_add,":max_range",":range_add"),
        (store_add,":max_damage",":damage",":damage_add"),
        (store_mul,":spec_power",":power", 2),
      (try_end),
      
      (try_begin),
        (this_or_next|eq, ":shooter_troop", "trp_knight_9_20"),
        (agent_has_item_equipped,":shooter","itm_magic_book_2"),
        (val_add,":max_range",":range_add"),
        (val_mul,":spec_power",":power", 2),
      (try_end),
      
      (try_begin),
        (eq, ":shooter_troop", "trp_knight_9_20"),
        (val_mul,":max_damage",":power", 4),
      (try_end),
      
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (copy_position, pos5, pos43),
        (try_end),
      
      (copy_position,pos6,pos5),
      (position_move_z,pos6,300),
      (particle_system_burst, "psys_spark_explosion_small", pos6, 5),
      (try_for_agents,":possable_agent"),
        (gt,":damage",0),
        (agent_is_alive,":possable_agent"),
        (this_or_next|agent_is_ally,":shooter"),
        (agent_is_ally,":possable_agent"),
        (this_or_next|neg|agent_is_ally,":possable_agent"),
        (neg|agent_is_ally,":shooter"),

        (agent_get_position,pos3,":possable_agent"),
        (get_distance_between_positions,":dist",pos5,pos3),
        (le,":dist",":max_range"),
        (assign,":agent",":possable_agent"),
        (val_add,":power",-1),
        (call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":max_damage", thunder, ":spec_power", ":power"),
        #(call_script, "script_magic_deliver_damage_to_agent", ":shooter", ":agent", ":damage", ice, 1, 15),
      (try_end),
    ])]

cast_magic_lightning_burst = [
  (ti_on_missile_hit, 
    [
      (store_trigger_param_1, ":shooter"),
      (copy_position,pos5,pos1),
      (agent_get_wielded_item, ":weapon", ":shooter", 0),
      (gt,":weapon",0),
      (assign,":damage",0),
      (item_has_property, ":weapon", itp_is_magic_staff),
      (agent_get_troop_id, ":shooter_troop", ":shooter"),
      (store_skill_level, ":power", skl_magic_power, ":shooter_troop"),
                                
      (try_begin),
        (assign,":range",100),
        (store_mul,":range_add",":power", 15),
        (store_div,":damage",":power", 3),
        (val_add,":range",":range_add"),
        (val_add,":damage",1),
      (try_end),
     
      (try_begin),
        (eq, ":shooter_troop", "trp_knight_9_20"),
        (val_add,":damage", 3),
      (try_end),
              
        (assign,":victim",-1),        
        (try_begin),
          (get_player_agent_no,":player"),
          (neq, ":player",":shooter"),
          (store_trigger_param_2, ":hit_object_type"),
          (neg|eq, ":hit_object_type", 1), # 1 = hostile agent
          (agent_ai_get_look_target, ":target", ":shooter"),
          (gt,":target",0),
          (neg|eq, ":shooter",":player"),
          (agent_is_alive,":target"),
          (assign,":victim",":target"),
        (try_end),
        
        (try_begin),
          (get_player_agent_no,":player"),
          (eq,":shooter",":player"),
          (eq, "$skill_mask_start", 1),
          (key_is_down, key_left_shift),
          (assign,":victim",-2),
        (try_end),

        (try_begin),
          (eq,":victim",-2),
          (copy_position, pos5, pos43),
        (else_try),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (eq,":victim",-1),
          
          (this_or_next|agent_is_ally,":shooter"),
          (agent_is_ally,":agent"),
          (this_or_next|neg|agent_is_ally,":agent"),
          (neg|agent_is_ally,":shooter"),
                              
          (agent_get_position, pos2, ":agent"),
          (get_distance_between_positions,":distance",pos2,pos5),
          (le,":distance",":range"),
          (call_script, "script_agent_get_num_companion_nearby", ":agent", 400),
          (assign, ":num_enemies", reg0),
          (this_or_next|le, ":num_enemies", 1),
          (ge, ":num_enemies", 6),
          (assign,":victim",":agent"),
        (try_end),
        (try_begin),
          (ge,":victim",0),
          (agent_get_position, pos5, ":victim"),
        (try_end),
        (copy_position,pos4,pos5),
        (try_for_range,":posz",0,":damage"),
          (store_random_in_range, ":posx", -2,3),
          (store_random_in_range, ":posy", -2,3),
          (val_mul,":posx",20),
          (val_mul,":posy",20),
          (val_mul,":posz",500),
          (position_move_x,pos4,":posx"),
          (position_move_y,pos4,":posy"),
          (position_move_z,pos4,":posz"),
          (add_missile, ":shooter", pos4, 0, ":weapon", 0, "itm_magic_lightningball", 0),
        (try_end),
    ])]
    
